- name: Authelia SSO
  hosts: homelab
  remote_user: root

  vars_files:
      - ../global.yml

  vars:
      service:
          name: authelia
          user: authelia
          publish:
              - "{{ network.internal_ip }}:{{ network.service_ports.authelia }}:80"
              - "{{ network.internal_ip }}:{{ network.service_ports.authelia_metrics }}:9959"
      volumes:
          subdirectories:
              - postgresql
              - config
      postgresql:
          database: authelia
          username: authelia
          password: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              65303933653135303339663936353662613539343564303836666438663631333635363861613839
              3231613865383738386661636138373730316561313533340a346162666439303166613836353466
              66633733613137396361333565653432393836326330356634663166313939616530343339666264
              3866623138303466660a326635623266333235303761643235373932633339643262383933653638
              33373830623934393930323064663338643265643139663733386662336362316563633333343464
              65656539346537373962653532356633643662396261313137663762653361373264613232636635
              353963303436313764386132336534653463
      redis:
          password: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              30326562373436306336306131633563323239366234386231646163656163313937353338376230
              6265376661626139356264306533323435323164623435370a333939623366623035646437643930
              61666639363932333137636437373761636562646463393036376264303566623164313638383466
              3538626331336663620a306365616235303564366533363164666233613735346265656137383464
              3466
      authelia:
          jwt_secret: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              31373861643563326261666432643563306465663337646636656266666463356435346334356537
              3933666136313432653331636261386632353634343032310a316137643530323432376434333835
              37343039353565383666646232393566316339613864366234336166376639646138623165613264
              6636373538363465330a333036613435653061306664323764323663393539643934613637333739
              37353633613564626531623261316461636166633963316434333634643836663863396162363764
              66386466643961633661393933666530346135303533636133336331333735656232396135633365
              61633362623931613033386366313039316432393264623431366233333438343538326363306165
              66376339373064323736353461373130326162353466666239346436313063373833316534643263
              35663634666164663164643036656632623437633865373465333035373565366562376163643939
              33646461636563303130343931363966386634653238363564353936363437373639616237366366
              34653239316437363464626639373735633962393261633564343531613139373065393366316561
              33653965663162643432663532616332346632383264353061356462363764623866383835383264
              33343134313636383330343330353833383865373530616431336137356639346537303561366533
              37613133306535326333323138396339303532343237663334326564323666663665653330646639
              35363561643733326139636662303065333365316538656430336464313631343835333033643633
              37373335383135613433626565323332626532626633613466366538313530643866313932333638
              65393964316665643332313738616234343737326363653430353636383730663331653164363763
              64663131343038656166646337366361646664633863643633326264376263646336316138653630
              36303632393335396232396132343539616538616133653964663535326464326661363635393564
              65303532343666383137613835653934363135383264313039383863353965643336643530313938
              37646436633137363934303065656434306631333864353738616438623437663134373335326536
              3566393736653065363631346337363232383237633130393931
          encryption_key: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              64303432336232616562636630363339653939386166316366653830643339316263343361336135
              6533653165643630383036633830666330373035636330360a613733646332613466613836343334
              30343461623331393663363065623061636432623864643336323562356339366435616465353837
              6235663033373938610a656363336165666535343735616366366234316639303339336361623334
              37663265656537653866356665383233376334323063633835373066616637313130623736366261
              3761383962343232316231333365313638633931343066363661
          session_secret: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              34366661666465326163646463653735326263656437346539323861323532326234333139613039
              3365653638323537306531383030303333643430363364300a303666653061346630633231356363
              39623332636130643038363163633962353936303135336462353733343466316466373535333037
              6638346339366635340a343061313361633532393132326631653264373366663435383133626336
              37666464643162353034656532623335366663396265633361316139636463333761636633323964
              6339336131383764636439343038616336306531633530393734

  tasks:
      - name: Service user
        ansible.builtin.include_tasks: tasks/service_user.yml

      - name: Volume directories
        ansible.builtin.include_tasks: tasks/volume_directory.yml

      - name: Service pod
        ansible.builtin.include_tasks: tasks/pod.yml

      - name: Database
        vars:
            postgresql_volume: "{{ volume_subdirectory_output.results[0].path }}"
        ansible.builtin.include_tasks: tasks/postgresql.yml

      - name: Redis
        ansible.builtin.include_tasks: tasks/redis.yml

      - name: Copy config template
        ansible.builtin.template:
            src: configs/authelia.yml
            dest: "{{ volume_subdirectory_output.results[1].path }}/configuration.yml"
            mode: u=rw

      - name: Authelia container
        become: true
        become_user: "{{ service.user }}"
        containers.podman.podman_container:
            name: "{{ service.name }}_server"
            state: "{{ container_state | default('started') }}"
            pod: "{{ service.name }}"
            image: "docker.io/authelia/authelia:{{ versions.authelia }}"
            log_driver: json-file
            log_options:
                path: "{{ container_log_directory_output.path }}/container.log"
            recreate: true
            restart_policy: on-failure
            volume:
                - "{{ volume_subdirectory_output.results[1].path }}:/config:ro"
