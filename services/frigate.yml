- name: Frigate NVR
  hosts: marion
  remote_user: root

  vars_files:
      - ../global.yml

  vars:
      service:
          name: frigate
          user: frigate
      rstp_user:
          username: nvr_rtsp
          password: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              33663338353164613962326262323434643539663733313931626138323030613061636532386236
              6334663966653735613163626633373666383238363765610a643031306662363931616165613761
              61643337616537376638623536386131343837366331303633643161613666313736636461303631
              3139663062373231330a323362643432316634316239356432353034316666323361393238376234
              32373433396461363264643730313137613038363362393138656266636332623438

  roles:
      - service_user

      - role: directories
        directories_options:
            volume:
                subdirectories:
                    - config

      #   - role: cron_restart
      #     cron_restart_options:
      #         identifier: "{{ service.name }}"
      #         time:
      #             hour: 3
      #         containers: "{{ service.name }}"

  tasks:
      - name: Frigate container
        become: true
        become_user: "{{ service.user }}"
        containers.podman.podman_container:
            name: "{{ service.name }}"
            state: "{{ container_state | default('started') }}"
            image: "ghcr.io/blakeblackshear/frigate:{{ versions.frigate }}-tensorrt"
            log_driver: "{{ podman.log_driver }}"
            log_options:
                path: "{{ directories_logs_output.path }}/{{ podman.container_log_file }}"
            restart_policy: "{{ podman.restart_policy | regex_replace('[^A-Za-z0-9-:]', '') }}"
            network: "{{ podman.network }}"
            publish:
                - "{{ network.internal_ip }}:{{ network.service_ports.frigate_web }}:8971"
            volumes:
                - "{{ directories_volume_subdirectories_output.results[0].path }}:/config"
                - "{{ filesystem.media.nvr }}:/media/frigate"
            mounts:
                # Cache in RAM
                - type=tmpfs,tmpfs-size=1024M,destination=/tmp/cache
            device:
                - nvidia.com/gpu=all
            env:
                NVIDIA_DRIVER_CAPABILITIES: all
                NVIDIA_VISIBLE_DEVICES: all
                YOLO_MODELS: yolov7-320,yolov7x-640
            group_add:
                - keep-groups
            shm_size: 512mb
