- name: Homepage
  hosts: homelab
  remote_user: root

  vars_files:
      - ../global.yml

  vars:
      service:
          name: homepage
          user: homepage
      api_keys:
          jellyfin: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              38666439613536666130396133376562656663376563636334366136346336386561636131366530
              3534366431613139666536383834613330616638383239650a643035336433383132353961303438
              31633830646136366466396634386166643332643433616436313232323033323334633435326661
              6536303234303732310a666136653033346564646537353538383662653432643239656433643863
              35313533313066343333633135333438623734643464316531643139323161626230366161613536
              6562313335396662613230323364386432656230653433626632
          pihole: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              33376133336437663135626136643264363837336337646664386464343139383765366264616537
              3563643561653137386431343964306439343737646635350a323265393437383631356535653033
              34616361316531643034636363326633303931313663666561303634616138656333303832353230
              3331613735336665650a396531303036313561393937663066643265346534643939623163613231
              31383433613262373733653232663565376231653734323764643938333131623836363463333837
              61346365643832373664333631333561343264643864633161343964656462383437316431663664
              61353035363730663464646336353933336337343534353532626633643666306334613130643038
              63623666313735643137
          deluge: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              34613634306263333466353764333938613163353161363237323130373539366236656630646638
              3038636662643638316333333264393434313830633166310a386133313434353732613466393232
              33636330303433313838373866333064313565613865396165646264313562613963636163313039
              6136306538363462340a346265383638643130313063646138666531303964323631623163633663
              61323664663732633566306438303965393137323139353531313739666631393738
          radarr: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              32363464623966303732623732303937346462353563396665656264613963333166366335316137
              3461396462366131643661363639343939336666633036390a643564336332613466363261303335
              33336262643264643537373431643234623536326130633235636565356165656239393665666330
              6231313063613234660a613439373166343035613865366531383130396463626234613133383362
              61353839326566666533303236383466613633666462613465623836313339396664333437363836
              3631666438306435386530336439386639616565393464376231
          sonarr: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              33366333323632636133613161623237633863303561353238323032393033646533383337383965
              3234386161653831316361316636343434646363373664630a376335373330363839303661323563
              66613765663463366632323037633364383534353561393135356431366566376363303536396665
              6230336633393333300a376664616438363935393933613062326537396665306163326534393035
              65333631636538383033613732393536643462346665306334346464366165306636316333376465
              3632633766646332313033336337663062316361623831363134
          jellyseerr: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              62623065356662323866316566326162306632633035643165313563353133386535643661636164
              3431396462653932376461326437663164346161383561620a333335653532666537346565343430
              66393135393166336230323531363033383065356437643139363161626662356538626237313138
              3561353561336362660a653563303930663030643361333732366539323964363164363330656261
              61376330623331613636616534643634363434643930333764316238653334363566663639353134
              65373763613835303930303631353465373761663366383862626466636236363834356130616461
              63373865333066366535356136363932316166373431363036326563643133653236323539346466
              38616434643063363662

  tasks:
      - name: Service user
        ansible.builtin.include_tasks: tasks/service_user.yml

      - name: Volume directories
        ansible.builtin.include_tasks: tasks/volume_directory.yml

      - name: Generate config from templates
        ansible.builtin.template:
            src: "{{ item.src }}"
            dest: "{{ volume_directory_output.path }}/{{ item.path }}"
            owner: "{{ service.user }}"
            group: "{{ service.user }}"
            mode: u=rw
        with_community.general.filetree: configs/homepage
        when: item.state == 'file'

      - name: Homepage container
        become: true
        become_user: "{{ service.user }}"
        containers.podman.podman_container:
            name: "{{ service.name }}"
            state: "{{ container_state | default('started') }}"
            image: "ghcr.io/gethomepage/homepage:{{ versions.homepage }}"
            log_driver: json-file
            log_options:
                path: "{{ container_log_directory_output.path }}/container.log"
            recreate: true
            restart_policy: on-failure:10
            network:
                - pasta
            publish:
                - "{{ network.internal_ip }}:{{ network.service_ports.homepage }}:3000"
            volumes:
                - "{{ volume_directory_output.path }}:/app/config"
