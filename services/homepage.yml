- name: Homepage
  hosts: homelab
  remote_user: root

  vars_files:
      - ../global.yml

  vars:
      service:
          name: homepage
          user: homepage
      api_keys:
          jellyfin: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              63323366303933666534313732343339306137643638326339656461653264393566343735333230
              3230613131303337376432613430326230353465323262380a326531326133636264353031306236
              39366535646335306462373565333830333861653333653133336539313163343866613135336163
              3831643265356336350a653837366635613331306631326166393263376439363536336236633638
              61616432636236383564306437613463363836316665643565356366356562636131343963366264
              3264613639333733363738396533336636653133303333616266
          qbittorrent: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              63376335383762623839653631376261333436353730643966636266393537306365666363646439
              3131616534366362323536663038653461623833336465650a623566623731316635333935666365
              32333536373365656138386563303033643338333466633433646132653161353432303166383637
              3362633865363936340a656331653462373634656536323937643839313434353734323165336264
              61386134643163386236336262666433653338373066313338613938303135636230
          radarr: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              39336132663162373165383761666232356236383862646335303966313466353933623235333836
              6265363235383464656330383035326531343263326266630a613264643931613536646438613334
              30353764383432646664653663333534396533306365613530373332666136616136333364306562
              3535353137313466610a643032666664653033626235316661646630363039386430373935366463
              61323064323836396466303166363664666534343431336164393634363332343037616666633532
              3532376434353131303834633131613431643634326333646461
          sonarr: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              34373761633832663133666136333466333935663564346461313438376338306461653539393432
              3761383632383864656435633266393464626539383538330a303566373038656165633433323963
              62356164343131653434656238306665633335376533646138643066396331316435323266643162
              6638343031656164620a646139613839643738306337363030386235393339353366373661663835
              65356635316132383433663366346363643934383539306530666661616562656438393635383631
              3461626366633434366564336162363062313532663264396464
          unifi:
              username: homepage
              password: !vault |
                  $ANSIBLE_VAULT;1.1;AES256
                  65366564373636363532656664623837646265646235366434346133343064343861346533373033
                  3730316430316535303135653464653462623338343661330a333763316639373636363366316163
                  31396532663366393364303839323333353766663432373839343334366635643435346239653035
                  3564666231323838620a393063303638633938333664306239373432633764343138343734376532
                  36363832333339633564656434376465356230333766303935636130653761613237

  tasks:
      - name: User
        ansible.builtin.import_role:
            name: service_user

      - name: Directories
        ansible.builtin.import_role:
            name: directories
        vars:
            directories_container_volume:
                create: true

      - name: Generate config from templates
        ansible.builtin.template:
            src: "{{ item.src }}"
            dest: "{{ dirs_container_volume.path }}/{{ item.path }}"
            owner: "{{ service.user }}"
            group: "{{ service.user }}"
            mode: u=rw
        with_community.general.filetree: configs/homepage
        when: item.state == 'file'

      - name: Homepage container
        become: true
        become_user: "{{ service.user }}"
        containers.podman.podman_container:
            name: "{{ service.name }}"
            state: "{{ container_state | default('started') }}"
            image: "ghcr.io/gethomepage/homepage:{{ versions.homepage }}"
            log_driver: "{{ podman.log_driver }}"
            log_options:
                path: "{{ dirs_container_logs.path }}/{{ podman.container_log_file }}"
            restart_policy: "{{ podman.restart_policy | regex_replace('[^A-Za-z0-9-:]', '') }}"
            network: "{{ podman.network }}"
            publish:
                - "{{ network.internal_ip }}:{{ network.service_ports.homepage }}:3000"
            volumes:
                - "{{ dirs_container_volume.path }}:/app/config"
